---
title: "sample size calculations, various RCTs and surveys"
author: "A.Amstutz"
date: "2023-10-18"
output:
  html_document:
    keep_md: yes
    toc: yes
    toc_float: yes
    code_folding: hide
  pdf_document:
    toc: yes
---

# Load packages
```{r load packages, echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(writexl)
library(tableone)
library(here)
library(kableExtra)
library(jtools) # for summ() and plot_summs
library(sjPlot) # for tab_model
library(ggplot2) # survival/TTE analyses and other graphs
library(ggfortify) # autoplot

library(pwr)

```

# Sample size for a binary outcome / individual randomized trial
```{r, include=FALSE}
# Define the parameters
effect_size <- 0.2  # The desired effect size (difference in proportions)
alpha <- 0.05      # Significance level (usually 0.05 for a 95% confidence interval)
power <- 0.80      # Desired power (usually 0.80 for 80% power, 0.9)

# calculate the sample size using pwr
sample_size <- pwr.2p.test(h = effect_size, 
                           sig.level = alpha, 
                           power = power)

# print
cat("Required Sample Size:", round(sample_size$n, 0))

---- 
# Define the parameters for a "manual calculation"
alpha <- 0.05      # Significance level (usually 0.05 for a 95% confidence interval)
power <- 0.80      # Desired power (usually 0.80 or 80% power)
p1 <- 0.4          # Estimated proportion in group 1
p2 <- 0.6          # Estimated proportion in group 2

Z_alpha_half <- qnorm(1 - alpha / 2) # translate into Z-distribution -> equals 0.975 (95% CI) 
Z_beta <- qnorm(power)

# calculate the sample size using the formula itself
sample_size <- ((Z_alpha_half + Z_beta)^2 * (p1 * (1 - p1) + p2 * (1 - p2))) / (p1 - p2)^2

# print
cat("Required sample size:", round(sample_size, 0))

```
# Sample size calculation for a continous outcome / individual randomized trial
```{r}
# Define the parameters
alpha <- 0.05      # Significance level (usually 0.05 for a 95% confidence interval)
power <- 0.80      # Desired power (usually 0.80 or 80% power)
mean_group1 <-  # Mean of the first group
mean_group2 <-  # Mean of the second group
standard_deviation <-  # Your estimated standard deviation
  
# Calculate the effect size
effect_size <- (mean_group1 - mean_group2) / standard_deviation

# Calculate sample size
sample_size <- pwr.t.test(d = effect_size, 
                          sig.level = alpha, 
                          power = power, 
                          sd = standard_deviation, 
                          type = "two.sample")
# Print
cat("Required sample size:", round(sample_size$n, 0))
```

# Sample size calculation for a clustered survey
```{r}
# Define the parameters
confidence_level <- 0.95 # confidence level
z <- qnorm(1 - (1 - confidence_level) / 2) # z statistic
d <- 0.05 # margin of error
cluster_size <- 3 # Average cluster size (fixed in our case)
icc <- 0.05 # Intracluster correlation coefficient
prop <- 0.7 # Estimated target proportion/prevalence

# Calculate design effect
deff <- 1 + (cluster_size - 1) * icc # Design Effect

# Calculate sample size
sample_size <- ceiling((z * sqrt(prop * (1 - prop)) / d)^2 / deff)

# Print
cat("Required sample size:", sample_size)
```

# Sample size calculation for a cluster randomized trial
```{r}
# Define the parameters
alpha <- 0.05      # Significance level (usually 0.05 for a 95% confidence interval)
power <- 0.80      # Desired power (usually 0.80 or 80% power)
mean_group1 <-  # Mean of the first group
mean_group2 <-  # Mean of the second group
standard_deviation <-  # Your estimated standard deviation
cluster_size <-  # Average cluster size
intracluster_correlation <-  # Intracluster correlation coefficient

# Calculate the effect size (delta)
delta <- abs(mean_group1 - mean_group2)

# Calculate the critical values for Z_alpha/2 and Z_beta
Z_alpha_half <- qnorm(1 - alpha / 2)
Z_beta <- qnorm(power)

# Calculate the design effect
design_effect <- 1 + (cluster_size - 1) * intracluster_correlation

# Calculate the total sample size (N)
N <- (2 * (standard_deviation^2) / delta^2) * ((Z_alpha_half + Z_beta)^2)

# Calculate the required sample size (n)
sample_size <- N / design_effect

# Print the sample size
cat("Required Sample Size for Cluster Randomized Trial:", round(sample_size, 0))

```

